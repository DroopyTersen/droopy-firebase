{"version":3,"sources":["../src/collection.js"],"names":["Collection","db","name","fetchOnce","refPath","ref","once","then","snapshot","val","prototype","_onAdd","handler","child","orderByChild","startAt","Date","now","on","eventKey","data","key","_getItemRef","set","obj","Error","_timestamp","add","get","getItems","Object","keys","map","k","update","updates","remove","clear","empty","module","exports"],"mappings":"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","file":"collection.js","sourcesContent":["var Collection = function(db, name) {\r\n    this.name = name;\r\n    this.db = db;\r\n}\r\n\r\nvar fetchOnce = function(refPath, db) {\r\n    return db.ref(refPath)\r\n        .once(\"value\")\r\n        .then(snapshot => snapshot.val()) \r\n}\r\nCollection.prototype._onAdd = function(handler) {\r\n    this.db.ref()\r\n        .child(this.name)\r\n        .orderByChild('_timestamp')\r\n        .startAt(Date.now())\r\n        .on('child_added', (snapshot) => handler(snapshot.val()))\r\n}\r\n\r\nCollection.prototype.on = function(eventKey, handler) {\r\n    let ref = this.db.ref().child(this.name);\r\n    if (eventKey === \"add\") {\r\n        this._onAdd(handler);\r\n    } else if (eventKey === \"update\") {\r\n        ref.on(\"child_changed\", snapshot => handler(snapshot.val()))\r\n    } else if (eventKey === \"remove\") {\r\n        ref.on(\"child_removed\", snapshot => handler(snapshot.val()))\r\n    } else {\r\n        ref.on(eventKey, function(data) {\r\n            handler(data.val() || data.key)\r\n        });\r\n    }\r\n}\r\n\r\nCollection.prototype._getItemRef = function(key) {\r\n    return this.db.ref(this.name + \"/\" + key);\r\n}\r\n\r\nCollection.prototype.set = function(obj) {\r\n    if (!obj.key) throw new Error(\"You must pass object with 'key'\")\r\n    obj._timestamp = Date.now()\r\n    this._getItemRef(obj.key).set(obj)\r\n}\r\nCollection.prototype.add = Collection.prototype.set;\r\n\r\nCollection.prototype.get = function(key) {\r\n    return fetchOnce(this.name + \"/\" + key, this.db);\r\n};\r\n\r\nCollection.prototype.getItems = function() {\r\n    return fetchOnce(this.name, this.db)\r\n        .then(val => val ? Object.keys(val).map(k => val[k]) : [])\r\n};\r\n\r\nCollection.prototype.update = function(key, updates) {\r\n    this._getItemRef(key).update(updates)\r\n};\r\n\r\nCollection.prototype.remove = function(key) {\r\n    this._getItemRef(key).remove();\r\n};\r\n\r\nCollection.prototype.clear = function() {\r\n    this.db.ref().child(this.name).set({});\r\n};\r\n\r\nCollection.prototype.empty = function() {\r\n    this.clear();\r\n};\r\nmodule.exports = Collection;"]}