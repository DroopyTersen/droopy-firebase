{"version":3,"sources":["../src/collection.js"],"names":["Collection","db","name","fetchOnce","refPath","ref","once","then","snapshot","val","prototype","_onAdd","handler","child","orderByChild","startAt","Date","now","on","off","eventKey","err","console","log","data","key","_getItemRef","set","obj","Error","_timestamp","add","get","getItems","Object","keys","map","k","update","updates","remove","clear","empty","module","exports"],"mappings":"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","file":"collection.js","sourcesContent":["var Collection = function(db, name) {\r\n    this.name = name;\r\n    this.db = db;\r\n}\r\n\r\nvar fetchOnce = function(refPath, db) {\r\n    return db.ref(refPath)\r\n        .once(\"value\")\r\n        .then(snapshot => snapshot.val()) \r\n}\r\nCollection.prototype._onAdd = function(handler) {\r\n    this.db.ref()\r\n        .child(this.name)\r\n        .orderByChild('_timestamp')\r\n        .startAt(Date.now())\r\n        .on('child_added', (snapshot) => handler(snapshot.val()))\r\n}\r\n\r\nCollection.prototype.off = function(eventKey) {\r\n    try {\r\n        this.db.ref().child(this.name).off(eventKey);\r\n    } catch(err) {\r\n        console.log(\"Unable to unsubscribe to Firebase event\");\r\n    }\r\n}\r\nCollection.prototype.on = function(eventKey, handler) {\r\n    let ref = this.db.ref().child(this.name);\r\n    if (eventKey === \"add\") {\r\n        this._onAdd(handler);\r\n    } else if (eventKey === \"update\") {\r\n        ref.on(\"child_changed\", snapshot => handler(snapshot.val()))\r\n    } else if (eventKey === \"remove\") {\r\n        ref.on(\"child_removed\", snapshot => handler(snapshot.val()))\r\n    } else {\r\n        ref.on(eventKey, function(data) {\r\n            handler(data.val() || data.key)\r\n        });\r\n    }\r\n}\r\n\r\nCollection.prototype._getItemRef = function(key) {\r\n    return this.db.ref(this.name + \"/\" + key);\r\n}\r\n\r\nCollection.prototype.set = function(obj) {\r\n    if (!obj.key) throw new Error(\"You must pass object with 'key'\")\r\n    obj._timestamp = Date.now()\r\n    return this._getItemRef(obj.key).set(obj)\r\n}\r\nCollection.prototype.add = Collection.prototype.set;\r\n\r\nCollection.prototype.get = function(key) {\r\n    return fetchOnce(this.name + \"/\" + key, this.db);\r\n};\r\n\r\nCollection.prototype.getItems = function() {\r\n    return fetchOnce(this.name, this.db)\r\n        .then(val => val ? Object.keys(val).map(k => val[k]) : [])\r\n};\r\n\r\nCollection.prototype.update = function(key, updates) {\r\n    return this._getItemRef(key).update(updates)\r\n};\r\n\r\nCollection.prototype.remove = function(key) {\r\n    this._getItemRef(key).remove();\r\n};\r\n\r\nCollection.prototype.clear = function() {\r\n    return this.db.ref().child(this.name).set({});\r\n};\r\n\r\nCollection.prototype.empty = function() {\r\n    return this.clear();\r\n};\r\nmodule.exports = Collection;"]}